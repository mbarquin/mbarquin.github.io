<!DOCTYPE html><html lang="es-ES"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Publicación de desarrollos, análisis y tests sobre las nuevas librerías y herramientas para la programación PHP"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@mercenariophp"><meta name="twitter:title" content="Descarga de ficheros comprimidos con ArchiveStream-php"><meta name="twitter:description" content="Los tutoriales de Symfony han sido bastante extensos, no penséis que han acabado, pero voy a intentar llenar un poco el hueco entre ellos... Mientras escribía, he leído un post de Ye Tian para weebly en el que hablan de esta librería, maennchen/ZipStream-PHP, aunque finalmente he acabado probando ArchiveStream-php"><title>Descarga de ficheros comprimidos con ArchiveStream-php | mercenariophp</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Descarga de ficheros comprimidos con ArchiveStream-php</h1><a id="logo" href="/.">mercenariophp</a><p class="description">Experimentos y anotaciones de un dev</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> Inicio</i></a><a href="/archives/"><i class="icon-archive"> Archivo</i></a><a href="/repos/"><i class="icon-github"> Repos</i></a><a href="/mbarquin/"><i class="icon-about"> mbarquin</i></a><a href="/atom.xml"><i class="icon-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Descarga de ficheros comprimidos con ArchiveStream-php</h1><div class="post-meta">10 / 02 / 2017<span class="categories"> | Guardado en<a href="/categories/Desarrollo/"> Desarrollo</a></span></div><span data-disqus-identifier="descarga-ficheros-comprimidos-Archivestream-php/" class="disqus-comment-count"></span><div class="post-content"><p>Hoy toca algo más liviano, los tutoriales de Symfony han sido bastante extensos, no penséis que han acabado, pero voy a intentar llenar un poco el hueco entre ellos… Mientras escribía, he leído un <a href="https://engineering.weebly.com/blog/streamed-file-zipping-and-downloading-in-php" target="_blank" rel="noopener">post</a> de Ye Tian para weebly en el que hablan de esta librería, <a href="https://github.com/maennchen/ZipStream-PHP" target="_blank" rel="noopener">maennchen/ZipStream-PHP</a>. Es una librería que nos <strong>permite agregar varios archivos a un comprimido Zip/Tar para su descarga</strong> de manera muy sencilla. Plantean un caso bastante simple, en el que vuelcan el contenido de ficheros a variables para ser enviados a descarga, esta librería los comprime en zip/tar y transmite al cliente. Viendo el repositorio de origen entiendo que es posible hacerlo sin tener que consumir memoria con un proceso intermedio. Además es posible <strong>empaquetar múltiples ficheros</strong> a este comprimido y facilitar en una única descarga todos los elementos que deseemos. Tras las primeras pruebas he comprobado que <strong>la librería presenta algunas issues</strong>, de manera que el soporte para grandes ficheros (para mi lo más interesante) queda inutilizado. Al hacer stat sobre ficheros de más de dos Gigas parece que se calcula mal el tamaño y lo trata como un archivo pequeño, intentando meterlo en memoria. En Github pude comprobar que no solo falla el stat, si no que la propia compresión Zip tampoco soporta volúmenes de más de 2Gb. Siguiendo los comentarios pude llegar a este <strong>“fork”</strong> de la herramienta, <a href="https://github.com/barracudanetworks/ArchiveStream-php" target="_blank" rel="noopener">barracudanetworks/ArchiveStream-php</a>, que si es capaz de realizar la tarea para todos los tamaños de fichero necesarios. Eso si, para los archivos muy grandes no realiza compresión, si no que los almacena sin comprimir en el mismo paquete.</p>
<a id="more"></a>

<h3 id="Compresion-de-ficheros-a-descargar"><a href="#Compresion-de-ficheros-a-descargar" class="headerlink" title="Compresión de ficheros a descargar"></a>Compresión de ficheros a descargar</h3><p>La instalación de la librería es sencilla, <strong>necesitamos tener la extensión gmp para PHP instalada</strong>, añadimos el require de composer, y, al hacer el update ya recibiremos la librería y tendremos actualizado el autoloading.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"barracudanetworks/archivestream-php"</span>: <span class="string">"1.*"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Una vez tenemos el vendor ya instalado sera cuestión de hacer la instancia del objeto y añadirle los ficheros necesarios con cualquiera de los métodos facilitados, El propio ArchiveStream se encargara de recoger los datos del fichero y empaquetarlos para su envío. No hace falta que nos preocupemos de más, ya el propio objeto, tras invocar el método <strong>finish()</strong>, se encargará de setear los headers de descarga y volcar el contenido.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">require</span> <span class="string">'../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Seteamos esto para comprobar el consumo de memoria</span></span><br><span class="line">    ini_set(<span class="string">'memory_limit'</span>, <span class="string">'128M'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cuidado con el execution time</span></span><br><span class="line">    ini_set(<span class="string">'max_execution_time'</span>, <span class="string">'0'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Forzamos compresión ZIP</span></span><br><span class="line">    $zip  = <span class="keyword">new</span> \Barracuda\ArchiveStream\ZipArchive(<span class="string">'download.zip'</span>);</span><br><span class="line"></span><br><span class="line">    $zip-&gt;add_file_from_path(<span class="string">'myImage.jpg'</span>, <span class="string">'/path/to/files/myImage.jpg'</span>);</span><br><span class="line">    $zip-&gt;add_file_from_path(<span class="string">'reallyBigFile.sql'</span>, <span class="string">'/another/path/to/files/reallyBigFile.sql'</span>);</span><br><span class="line"></span><br><span class="line">    $zip-&gt;finish();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    Si queremos leer un archivo de un contexto diferente se pueden pasar directamente las partes.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    $fh       = fopen($filePath, 'r');</span></span><br><span class="line"><span class="comment">//    $stat = fstat($fh);</span></span><br><span class="line"><span class="comment">//    $zip-&gt;init_file_stream_transfer($filePath, $stat['size']);</span></span><br><span class="line"><span class="comment">//    while (feof($fh) === false) &#123;</span></span><br><span class="line"><span class="comment">//        $zip-&gt;stream_file_part(fread($fh, 1048576));</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    $zip-&gt;complete_file_stream();</span></span><br><span class="line"><span class="comment">//    $zip-&gt;finish();</span></span><br></pre></td></tr></table></figure>

<p>Realmente sencillo, y la librería es bastante ligera, un buen complemento para simplificar las tareas de descarga de comprimidos en nuestras aplicaciones.</p>
</div><div class="tags"><a href="/tags/PHP/">PHP</a><a href="/tags/Herramientas/">Herramientas</a><a href="/tags/Tutorial/">Tutorial</a></div><div class="post-nav"><a href="/tutorial-symfony-bundles-knpmenubundle/" class="pre"><i class="icon-previous">Tutorial de Symfony 3: Bundles y KnpMenuBundle</i></a><a href="/tutorial-symfony-doctrine-orm/" class="next">Tutorial de Symfony 3: Doctrine ORM y Base de Datos<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'mercenariophp';
var disqus_identifier = 'descarga-ficheros-comprimidos-Archivestream-php/';
var disqus_title = 'Descarga de ficheros comprimidos con ArchiveStream-php';
var disqus_url = 'https://www.mercenariophp.com/descarga-ficheros-comprimidos-Archivestream-php/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mercenariophp.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"><input type="hidden" name="sitesearch" value="https://www.mercenariophp.com"></form></div><div class="widget lessMargin"><div style="text-align: left;"><div style="width: 84px; height: 40px;"><a href="https://twitter.com/mercenariophp" rel="nofollow" target="_blank" class="twitter_big"></a><a href="https://es.linkedin.com/in/moisés-barquín-salgado-b6148296" rel="nofollow" target="_blank" class="linkedin_big"></a></div></div></div><div class="widget"><div class="widget-title">Categorías</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Desarrollo/">Desarrollo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tutoriales-Symfony/">Tutoriales Symfony</a></li></ul></div><div class="widget"><div class="widget-title">Etiquetas</div><div class="tagcloud"><a href="/tags/tests/" style="font-size: 15px;">tests</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/PagesGenerator/" style="font-size: 15px;">PagesGenerator</a> <a href="/tags/Herramientas/" style="font-size: 15px;">Herramientas</a> <a href="/tags/Tutorial/" style="font-size: 15px;">Tutorial</a> <a href="/tags/PHPUnit/" style="font-size: 15px;">PHPUnit</a> <a href="/tags/Composer/" style="font-size: 15px;">Composer</a> <a href="/tags/NetBeans/" style="font-size: 15px;">NetBeans</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/ReactPHP/" style="font-size: 15px;">ReactPHP</a> <a href="/tags/Slim/" style="font-size: 15px;">Slim</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/Pattern/" style="font-size: 15px;">Pattern</a> <a href="/tags/Repositorio/" style="font-size: 15px;">Repositorio</a> <a href="/tags/Frameworks/" style="font-size: 15px;">Frameworks</a></div></div><div class="widget"><div class="widget-title">Recientes</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/php-dotenv-variables-entorno/">PHP Dotenv, configuración en variables de entorno</a></li><li class="post-list-item"><a class="post-list-link" href="/vacaciones/">Vacaciones</a></li><li class="post-list-item"><a class="post-list-link" href="/retornando-objetos-valor/">Retornando objetos de valor en lugar de arrays</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-bundles-knpmenubundle/">Tutorial de Symfony 3: Bundles y KnpMenuBundle</a></li><li class="post-list-item"><a class="post-list-link" href="/descarga-ficheros-comprimidos-Archivestream-php/">Descarga de ficheros comprimidos con ArchiveStream-php</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-doctrine-orm/">Tutorial de Symfony 3: Doctrine ORM y Base de Datos</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-twig/">Tutorial de Symfony 3: Twig, base layout con Bootstrap</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony/">Tutorial de Symfony 3: Instalación, routing y controllers</a></li><li class="post-list-item"><a class="post-list-link" href="/refactorizando-reactphp-slim/">Refactorizando reactphp-slim</a></li><li class="post-list-item"><a class="post-list-link" href="/editor-hackeable-atom/">Editor hackeable Atom, el editor para el siglo 21</a></li></ul></div><div class="widget"><div class="widget-title">Comentarios recientes</div><script type="text/javascript" src="//mercenariophp.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">Blogroll</div><ul></ul><a href="http://www.phptherightway.com/" title="PHP The Right Way" target="_blank">PHP The Right Way</a></div></div></div></div><div id="footer"><a href="https://twitter.com/mercenariophp" rel="nofollow" class="twitter"></a> <a href="https://es.linkedin.com/in/moisés-barquín-salgado-b6148296" rel="nofollow" class="linkedin"></a> © <a href="/." rel="nofollow">mercenariophp.</a> With<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-78289384-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>