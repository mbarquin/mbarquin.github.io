<!DOCTYPE html><html lang="es-ES"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Publicación de desarrollos, análisis y tests sobre las nuevas librerías y herramientas para la programación PHP"><title>Refactorizando reactphp-slim | mercenariophp</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Refactorizando reactphp-slim</h1><a id="logo" href="/.">mercenariophp</a><p class="description">Experimentos y anotaciones de un dev</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> Inicio</i></a><a href="/archives/"><i class="icon-archive"> Archivo</i></a><a href="/repos/"><i class="icon-github"> Repos</i></a><a href="/mbarquin/"><i class="icon-about"> mbarquin</i></a><a href="/atom.xml"><i class="icon-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Refactorizando reactphp-slim</h1><div class="post-meta">16 / 11 / 2016<span class="categories"> | Guardado en<a href="/categories/Desarrollo/"> Desarrollo</a></span></div><span data-disqus-identifier="refactorizando-reactphp-slim/" class="disqus-comment-count"></span><div class="post-content"><p>No estaba muy contento con el código de la librería <a href="https://github.com/mbarquin/reactphp-slim" target="_blank" rel="noopener">reactphp-slim</a>, parecía poco elegante. Así que me he puesto manos  a la obra y he decidido cambiar un poco la forma en que trabaja, de paso terminar de añadir cosas que faltaban. He generado un objeto Server encargado de setear los callbacks a <a href="http://reactphp.org/" target="_blank" rel="noopener">ReactPHP</a> para que haga la llamada al método process de la aplicación basada en <a href="http://www.slimframework.com/" target="_blank" rel="noopener">Slim Framework</a>. He generado dos clases estáticas encargadas del paso de datos entre los objetos request/response de ambos frameworks, siendo el objeto Server el pegamento de todo el paquete. Él se encarga de recoger la request, del arranque de la aplicación y de poblar la response, ocultando las llamadas que nosotros antes implementábamos a mano.</p>
<a id="more"></a>
<h3 id="Uso"><a href="#Uso" class="headerlink" title="Uso"></a>Uso</h3><p>Ahora es bastante más simple que antes, sencillamente instanciamos Slim/App para hacerle un bootstrap normal, las dependencias, el router, middleware… Después de tener la aplicación preparada, solamente deberemos instanciar el servidor reactphp-slim para setear el puerto a escuchar y hacer el run, esto pondrá nuestra aplicación a la escucha de cualquier petición HTTP.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> \<span class="title">mbarquin</span>\<span class="title">reactSlim</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We keep a new Slim app instance.</span></span><br><span class="line">$app = <span class="keyword">new</span> \Slim\App();</span><br><span class="line"></span><br><span class="line"><span class="comment">// We add a closure to attend defined request routes</span></span><br><span class="line">$app-&gt;any(<span class="string">'/hello/&#123;name&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        \Slim\Http\Request $request,</span></span></span><br><span class="line"><span class="function"><span class="params">        \Slim\Http\Response $response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        $name = $request-&gt;getAttribute(<span class="string">'name'</span>);</span><br><span class="line"></span><br><span class="line">        $response-&gt;getBody()-&gt;write(<span class="string">"Hello, $name"</span>);</span><br><span class="line">        $response-&gt;getBody()-&gt;write(print_r($request-&gt;getParsedBody(), <span class="keyword">true</span>));</span><br><span class="line">        $response-&gt;getBody()-&gt;write(print_r($request-&gt;getCookieParams(), <span class="keyword">true</span>));</span><br><span class="line">        $response-&gt;getBody()-&gt;write(print_r($request-&gt;getHeaders(), <span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">// $response-&gt;getBody()-&gt;write(print_r($request-&gt;getUploadedFiles(), true));</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">$server = <span class="keyword">new</span> \mbarquin\reactSlim\Server();</span><br><span class="line"></span><br><span class="line">$server-&gt;withHost(<span class="string">'192.168.67.1'</span>)-&gt;withPort(<span class="number">1337</span>)-&gt;run($app);</span><br></pre></td></tr></table></figure>

<p>La clase Server esta construida de manera que al invocar al método withPort o withHost, este nos devuelve propio objeto para poder concatenar el resto de los métodos.</p>
<p><strong>withHost($string)</strong><br>Define la IP que el servidor va a estar escuchando, por defecto localhost. Este método retorna la misma instancia Server.</p>
<p><strong>withPort($int)</strong><br>Configura el puerto al que el servidor va a estar escuchando, por defecto será 1337. Este método retorna la misma instancia Server.</p>
<p><strong>run(\Slim\App $app)</strong><br>Lanza el proceso de servidor y espera hasta que sea realizada una petición, momento en que lanza la instancia de Slim\App pasada como parámetro.</p>
<h3 id="Uploaded-files"><a href="#Uploaded-files" class="headerlink" title="Uploaded files"></a>Uploaded files</h3><p>Lo más laborioso ha sido imitar el comportamiento para recoger archivos desde los formularios multipart, la verdad que no conocía en profundidad el proceso conjunto que hacían el navegador y servidor para crear los archivos y ponerlos a disposición mediante $_FILES y move_uploaded_files. Los ficheros recibidos no serán validos para las funciones move_uploaded_files ni is_uploaded_file, PHP hace comprobaciones contra los datos de lo que él ha procesado, y estos no entrarían. Aun no lo he podido probar con usuarios concurrentes, el boundary enviado para la segmentación de los datos por parte del navegador sirve como identificador global de las partes de una misma descarga. A falta de más pruebas parece que los archivos recibidos son iguales a los enviados.</p>
<p>Para gestionarlos utilizaremos los objetos nativos de <a href="http://www.slimframework.com/" target="_blank" rel="noopener">Slim</a> obtenidos mediante $request-&gt;getUploadedFiles(), que ya tienen un método (moveTo) para poder copiarlos donde nosotros deseemos.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusión"></a>Conclusión</h3><p>He actualizado el proceso para poder recoger el contenido del Body, en la anterior versión quedó como algo pendiente, ahora ya se recoge y se pasa al objeto Request de <a href="http://www.slimframework.com/" target="_blank" rel="noopener">Slim</a>. Lo mismo con las Cookies y Headers, había un bug que evitaba la propagación de las nuevas cabeceras de la response seteadas en la aplicación <a href="http://www.slimframework.com/" target="_blank" rel="noopener">Slim</a> hacia el navegador, ya corregido.</p>
<p>Es un servidor experimental, pero el proceso de poner en marcha algo funcional esta siendo positiva, me está llevando por derroteros a los que de otra manera creo que no llegaría jamás. Queda pendiente algo de código para emular el comportamiento de las sessions, pero eso ya forma parte de un futuro hipotético…</p>
</div><div class="tags"><a href="/tags/PHP/">PHP</a><a href="/tags/Herramientas/">Herramientas</a><a href="/tags/ReactPHP/">ReactPHP</a><a href="/tags/Slim/">Slim</a></div><div class="post-nav"><a href="/tutorial-symfony/" class="pre"><i class="icon-previous">Tutorial de Symfony 3: Instalación, routing y controllers</i></a><a href="/editor-hackeable-atom/" class="next">Editor hackeable Atom, el editor para el siglo 21<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'mercenariophp';
var disqus_identifier = 'refactorizando-reactphp-slim/';
var disqus_title = 'Refactorizando reactphp-slim';
var disqus_url = 'https://www.mercenariophp.com/refactorizando-reactphp-slim/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mercenariophp.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"><input type="hidden" name="sitesearch" value="https://www.mercenariophp.com"></form></div><div class="widget lessMargin"><div style="text-align: left;"><div style="width: 84px; height: 40px;"><a href="https://twitter.com/mercenariophp" rel="nofollow" target="_blank" class="twitter_big"></a><a href="https://es.linkedin.com/in/moisés-barquín-salgado-b6148296" rel="nofollow" target="_blank" class="linkedin_big"></a></div></div></div><div class="widget"><div class="widget-title">Categorías</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Desarrollo/">Desarrollo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tutoriales-Symfony/">Tutoriales Symfony</a></li></ul></div><div class="widget"><div class="widget-title">Etiquetas</div><div class="tagcloud"><a href="/tags/tests/" style="font-size: 15px;">tests</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/PagesGenerator/" style="font-size: 15px;">PagesGenerator</a> <a href="/tags/Herramientas/" style="font-size: 15px;">Herramientas</a> <a href="/tags/Tutorial/" style="font-size: 15px;">Tutorial</a> <a href="/tags/PHPUnit/" style="font-size: 15px;">PHPUnit</a> <a href="/tags/Composer/" style="font-size: 15px;">Composer</a> <a href="/tags/NetBeans/" style="font-size: 15px;">NetBeans</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/ReactPHP/" style="font-size: 15px;">ReactPHP</a> <a href="/tags/Slim/" style="font-size: 15px;">Slim</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/Pattern/" style="font-size: 15px;">Pattern</a> <a href="/tags/Repositorio/" style="font-size: 15px;">Repositorio</a> <a href="/tags/Frameworks/" style="font-size: 15px;">Frameworks</a></div></div><div class="widget"><div class="widget-title">Recientes</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/php-dotenv-variables-entorno/">PHP Dotenv, configuración en variables de entorno</a></li><li class="post-list-item"><a class="post-list-link" href="/vacaciones/">Vacaciones</a></li><li class="post-list-item"><a class="post-list-link" href="/retornando-objetos-valor/">Retornando objetos de valor en lugar de arrays</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-bundles-knpmenubundle/">Tutorial de Symfony 3: Bundles y KnpMenuBundle</a></li><li class="post-list-item"><a class="post-list-link" href="/descarga-ficheros-comprimidos-Archivestream-php/">Descarga de ficheros comprimidos con ArchiveStream-php</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-doctrine-orm/">Tutorial de Symfony 3: Doctrine ORM y Base de Datos</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-twig/">Tutorial de Symfony 3: Twig, base layout con Bootstrap</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony/">Tutorial de Symfony 3: Instalación, routing y controllers</a></li><li class="post-list-item"><a class="post-list-link" href="/refactorizando-reactphp-slim/">Refactorizando reactphp-slim</a></li><li class="post-list-item"><a class="post-list-link" href="/editor-hackeable-atom/">Editor hackeable Atom, el editor para el siglo 21</a></li></ul></div><div class="widget"><div class="widget-title">Comentarios recientes</div><script type="text/javascript" src="//mercenariophp.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">Blogroll</div><ul></ul><a href="http://www.phptherightway.com/" title="PHP The Right Way" target="_blank">PHP The Right Way</a></div></div></div></div><div id="footer"><a href="https://twitter.com/mercenariophp" rel="nofollow" class="twitter"></a> <a href="https://es.linkedin.com/in/moisés-barquín-salgado-b6148296" rel="nofollow" class="linkedin"></a> © <a href="/." rel="nofollow">mercenariophp.</a> With<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-78289384-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>