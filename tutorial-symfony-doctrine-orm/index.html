<!DOCTYPE html><html lang="es-ES"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Publicación de desarrollos, análisis y tests sobre las nuevas librerías y herramientas para la programación PHP"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@mercenariophp"><meta name="twitter:title" content="Tutorial de Symfony 3: Doctrine ORM y Base de Datos"><meta name="twitter:description" content="Desde el punto en que acabamos el último día vamos a implementar la base de datos que vamos a necesitar para gestionar nuestras entidades, como primer desarrollo podemos destacar la necesidad de tener un pequeño blog."><meta name="twitter:image" content="https://www.mercenariophp.com/images/tutorialSymfony/doctrine_logo_lit.png"><title>Tutorial de Symfony 3: Doctrine ORM y Base de Datos | mercenariophp</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Tutorial de Symfony 3: Doctrine ORM y Base de Datos</h1><a id="logo" href="/.">mercenariophp</a><p class="description">Experimentos y anotaciones de un dev</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> Inicio</i></a><a href="/archives/"><i class="icon-archive"> Archivo</i></a><a href="/repos/"><i class="icon-github"> Repos</i></a><a href="/mbarquin/"><i class="icon-about"> mbarquin</i></a><a href="/atom.xml"><i class="icon-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Tutorial de Symfony 3: Doctrine ORM y Base de Datos</h1><div class="post-meta">01 / 02 / 2017<span class="categories"> | Guardado en<a href="/categories/Tutoriales-Symfony/"> Tutoriales Symfony</a></span></div><span data-disqus-identifier="tutorial-symfony-doctrine-orm/" class="disqus-comment-count"></span><div class="post-content"><p><img src="/images/tutorialSymfony/doctrine_logo_lit.png" alt><br>Desde el punto en que acabamos el último día vamos a implementar la base de datos que vamos a necesitar para gestionar nuestras entidades. Como primer desarrollo podemos destacar la necesidad de tener un pequeño blog, que, al acceder a la aplicación informe a nuestros usuarios de los últimos cambios o de las noticias relevantes. De paso aprovecharé para ver la implementación de los usos más cotidianos de acceso a la BD. No esperaba hacer entradas tan largas pero la verdad que a poco que te metes <a href="https://symfony.com/" target="_blank" rel="noopener">Symfony</a> y <a href="http://symfony.com/doc/current/doctrine.html" target="_blank" rel="noopener">Doctrine</a> se llevan tu tiempo, tienen una curva de aprendizaje pronunciada aunque bastante fácil de seguir, espero que no se os haga muy denso…</p>
<a id="more"></a>

<h3 id="Que-es-Doctrine-ORM"><a href="#Que-es-Doctrine-ORM" class="headerlink" title="Qué es Doctrine? ORM?"></a>Qué es Doctrine? ORM?</h3><p>Doctrine son un conjunto de librerías que nos va a simplificar todas las operaciones que realicemos con la base de datos, además de permitirnos abstraernos de la tecnología del servidor. Doctrine puede conectarse contra bases de datos como MySQL, PostgreSQL o Microsoft SQL, también tiene un conector para trabajar con MongoDB. Esta capa nos va a permitir trabajar con un estándar de definición de datos, tablas y relaciones mediante clases PHP. Posteriormente, el propio Doctrine se encargará de replicar en la Base de datos destino, de esta manera no necesitaremos conocer las rutinas de creación y mantenimiento en estos sistemas…</p>
<p>Es un <strong>ORM</strong>, es decir, un <strong>Object Relational Mapper</strong>, con esto entendemos que es capaz de mapear una base de datos relacional mediante objetos (Clases). Con las clases de Doctrine dispondremos de nuestras entidades (tablas) de datos como objetos PHP, que soportaran herencia y polimorfismo. Las operaciones que realicemos con estas clases no dependerán de sentencias escritas en SQL, si no que cada clase tendrá mapeados diferentes métodos y propiedades que nos permitirán realizar las mismas operaciones de manera independiente al lenguaje SQL.</p>
<h3 id="Configurando-la-base-de-datos"><a href="#Configurando-la-base-de-datos" class="headerlink" title="Configurando la base de datos."></a>Configurando la base de datos.</h3><p>En el archivo /app/config/parameters.yml tenemos configurado el acceso a la base de datos, los datos se han seteado al inicializar el proyecto con Composer en la primera parte del tutorial. Así que vamos a crear la base de datos para comenzar a definir las entidades de nuestro backend. Accedemos a la consola de MySQL o en su defecto con cualquier admin de MySQL nos conectamos al servidor, creamos la base de datos y le damos permisos al usuario.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> symfony;</span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> symfony.* <span class="keyword">to</span> <span class="string">'symfony'</span>@<span class="string">'localhost'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'pass54mfon4'</span>;</span><br></pre></td></tr></table></figure>

<p>Ahora hay que cambiar esos valores en el archivo parameters.yml.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/config/parameters.yml</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">    database_host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">    database_port:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">    database_name:</span> <span class="string">symfony</span></span><br><span class="line"><span class="attr">    database_user:</span> <span class="string">symfony</span></span><br><span class="line"><span class="attr">    database_password:</span> <span class="string">pass54mfon4</span></span><br><span class="line"><span class="attr">    mailer_transport:</span> <span class="string">smtp</span></span><br><span class="line"><span class="attr">    mailer_host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">    mailer_user:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">    mailer_password:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">    secret:</span> <span class="string">ThisTokenIsNotSoSecretChangeIt</span></span><br></pre></td></tr></table></figure>

<p>En la documentacion oficial proponen generar la base de datos con el propio Symfony mediante el comando</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php bin/console doctrine:database:create</span><br></pre></td></tr></table></figure>

<p>En ese caso necesitaríamos tener derechos de administrador para poder crear la base de datos, por ejemplo con el usuario root, con o sin password, aunque yo prefiero algo un poco más seguro. En la documentación de Symfony recomiendan usar el juego de caracteres utf8mb4_unicode_ci por defecto, cambiarlo en el my.cnf o directamente expresarle a doctrine nuestra preferencia en el archivo de configuración. La sección doctrine ya ha de existir al igual que la sub-sección dbal, sería cambiar en esta el <strong>charset</strong> y añadir las <strong>default_table_options</strong>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/config/config.yml</span></span><br><span class="line"><span class="attr">doctrine:</span></span><br><span class="line"><span class="attr">    dbal:</span></span><br><span class="line"><span class="attr">        charset:</span> <span class="string">utf8mb4</span></span><br><span class="line"><span class="attr">        default_table_options:</span></span><br><span class="line"><span class="attr">            charset:</span> <span class="string">utf8mb4</span></span><br><span class="line"><span class="attr">            collate:</span> <span class="string">utf8mb4_unicode_ci</span></span><br></pre></td></tr></table></figure>

<h3 id="Clase-de-entidad"><a href="#Clase-de-entidad" class="headerlink" title="Clase de entidad"></a>Clase de entidad</h3><p>Como ya sabemos las tablas de las bases de datos de denominan entidades y a nivel definición utilizamos ese concepto en los diagramas de relación. De manera que la clase encargada de mantener la información de la tabla de base de datos en Symfony se denomina entidad. En nuestro caso, el blog se va a corresponder con un apartado de notificaciones del backend, es decir, un cauce para que nuestra herramienta pueda comunicar a los usuarios las mejoras, cambios, o eventos del sistema a los que tengan que estar atentos. Vamos a crear una entidad para almacenar estos mensajes. Dentro del directorio src/AppBundle crearemos una nueva carpeta llamada <strong>Entity</strong> y dentro de esta crearemos el archivo PHP que dará vida a nuestra primera clase-entidad “Blog”. De momento esta entidad no la crearemos en base de datos, aun necesitamos completar la información de sus propiedades para que sea correctamente representada en SQL.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/AppBundle/Entity/Blog.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AppBundle</span>\<span class="title">Entity</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $id;</span><br><span class="line">    <span class="keyword">private</span> $title;</span><br><span class="line">    <span class="keyword">private</span> $content;</span><br><span class="line">    <span class="keyword">private</span> $created;</span><br><span class="line">    <span class="keyword">private</span> $modified;</span><br><span class="line">    <span class="keyword">private</span> $deleted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Mapeo-de-la-informacion"><a href="#Mapeo-de-la-informacion" class="headerlink" title="Mapeo de la información"></a>Mapeo de la información</h3><p>Doctrine es un ORM complejo que va más allá de recuperar datos de la base de datos en arrays asociativos sobre los que iterar. Doctrine nos permitirá obtener objetos de estos datos y nos permitirá hacer persistir estos objetos en la base de datos. Para esto debemos relacionar las tablas con los objetos que las representan y <strong>mapear</strong> las columnas de dichas tablas con las propiedades de sus clases correspondientes. Esta información de mapeo se puede proveer de múltiples maneras, a través de archivos yaml, xml o directamente en la propia clase, al igual que las rutas en los controladores, con anotaciones docBlock.</p>
<p>El nombre de la entidad en la base de datos se sacará de su definición, pero en caso de no existir, Symfony tratará de suponerlo utilizando el nombre de la clase.</p>
<p>Los métodos de mapeo no se pueden mezclar para cada bundle, debería ser realizado de una única manera, o bien yaml, o docBlock…</p>
<p>Crearemos la entidad Blog para poder hacer tests, así como la entidad Category, descrita un poco más abajo, <strong>dentro de la carpeta src/AppBundle/Entity</strong>. Hay que incluir el use del namespace del mapping de Symfony (use Doctrine\ORM\Mapping as ORM;) para que al utilizar la clase no genere problemas.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/AppBundle/Entity/Blog.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AppBundle</span>\<span class="title">Entity</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Mapping</span> <span class="title">as</span> <span class="title">ORM</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ORM</span>\Entity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ORM</span>\Table(</span></span><br><span class="line"><span class="comment"> *  name="blog",</span></span><br><span class="line"><span class="comment"> *  uniqueConstraints=&#123;</span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@ORM</span>\UniqueConstraint(name="slug_idx", columns=&#123;"slug"&#125;)</span></span><br><span class="line"><span class="comment"> *  &#125;,</span></span><br><span class="line"><span class="comment"> *  indexes=&#123;</span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@ORM</span>\Index(name="category_idx", columns=&#123;"category_id"&#125;)</span></span><br><span class="line"><span class="comment"> * &#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Column(type="integer")</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\GeneratedValue(strategy="AUTO")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Column(type="integer", name="category_id")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $category;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Column(type="string", length=255)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $title;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Column(type="string", length=150)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $slug;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Column(type="text")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@ORM</span>\Column(type="datetime") */</span></span><br><span class="line">    <span class="keyword">private</span> $created;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@ORM</span>\Column(type="datetime") */</span></span><br><span class="line">    <span class="keyword">private</span> $modified;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@ORM</span>\Column(type="datetime", nullable=true) */</span></span><br><span class="line">    <span class="keyword">private</span> $deleted = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Entidad Category:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/AppBundle/Entity/Category.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AppBundle</span>\<span class="title">Entity</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">ORM</span>\<span class="title">Mapping</span> <span class="title">as</span> <span class="title">ORM</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ORM</span>\Entity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ORM</span>\Table(name="category")</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Column(type="integer")</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\GeneratedValue(strategy="AUTO")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\Column(type="string", length=255)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@ORM</span>\Column(type="datetime") */</span></span><br><span class="line">    <span class="keyword">private</span> $created;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@ORM</span>\Column(type="datetime") */</span></span><br><span class="line">    <span class="keyword">private</span> $modified;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@ORM</span>\Column(type="datetime", nullable=true) */</span></span><br><span class="line">    <span class="keyword">private</span> $deleted = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Observando estos ejemplos podemos interpretar un poco como funciona el sistema de anotaciones, en primer lugar informamos al sistema que estamos generando una clase que da soporte a una entidad de la base de datos. Esto se hace con la anotación encima del nombre de la clase, <strong><code>@ORM\Entity</code></strong>, a continuación definimos el nombre de la tabla con la que se corresponde mediante la anotación <strong><code>@ORM\Table(name="blog")</code></strong>, esta última no es obligatoria, en caso de no existir, se utilizaría el nombre de la clase para suponer el de la tabla en Base de Datos.</p>
<p>Para relacionar cada propiedad con su columna correspondiente en la tabla se utiliza la anotación <strong><code>@ORM\Column</code></strong>. Entre paréntesis podemos declarar más parámetros relativos al dato, como la longitud o si acepta valores null, siempre con el mismo formato, nombre=valor y separados por comas.</p>
<ul>
<li>type<br>Define el tipo de campo, una cadena de texto (string), un entero (integer), un texto largo (text)… si no se define, el campo se tratará como un string. <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html#reference-mapping-types" target="_blank" rel="noopener">Aquí tenemos una referencia</a> de los types soportados por Symfony y el tipo de dato SQL equivalente.</li>
<li>name<br>El nombre de la columna de la tabla en la base de datos, generalmente es el mismo que el nombre de la propiedad, si queremos diferenciarlos utilizaremos este atributo.</li>
<li>length<br>La longitud máxima del valor en la base de datos. Limita la longitud total del tipo de dato definido, como podría pasar en MySQL, el varchar es de 255 caracteres pero nosotros lo podemos limitar a una longitud menor si así lo deseamos.</li>
<li>nullable<br>Indica que el campo puede contener un valor null.</li>
</ul>
<p>Si a una propiedad correspondiente a un campo le asignamos un valor, este será utilizado como el valor por defecto del campo.</p>
<p>Contamos con más anotaciones, como por ejemplo, para identificar la clave primaria <strong><code>@ORM\Id</code></strong>. En conjunción se puede indicar que la columna se autoincrementa respecto a la anterior en cada inserción, cada motor de base de datos lo define a su manera, mediante el ORM lo abstraemos y definimos con <strong><code>@ORM\GeneratedValue(strategy=&quot;AUTO&quot;)</code></strong>. Todo descrito en más profundidad en el documento enlazado <a href="(http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html#reference-mapping-types)">antes</a>.</p>
<p>También debemos prestar atención a los atributos en forma de array <strong>uniqueConstraints</strong> e <strong>indexes</strong> a traves de los cuales definiremos los índices y claves únicas de la tabla.</p>
<p>Solo queda indicar que si vamos a utilizar como nombre de una tabla, o de un campo, una palabra reservada, por ejemplo order, es mejor en la definición de la columna indicar el parámetro name con el valor entre acentos (ticks).</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ORM</span>\Column(name="`order`, "type="number")</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> $order;</span><br></pre></td></tr></table></figure>

<h3 id="Completado-de-la-clase"><a href="#Completado-de-la-clase" class="headerlink" title="Completado de la clase"></a>Completado de la clase</h3><p>Una vez tenemos el mapeado de la entidad en una clase de PHP, le podemos pedir a doctrine que nos genere los getters y setters de cada propiedad privada que que hemos mapeado a nuestra entidad, siempre respetando lo que ya tenemos. Muchos IDE’s ya implementan esta funcionalidad, por ejemplo en netbeans, si pulsamos alt+insert nos mostrará un popup donde podremos seleccionar las propiedades sobre las que queremos generar estos getters y setters. En ambos casos se va a respetar el trabajo previo que tengamos ya hecho en estos métodos. Debajo el comando shell/cmd para la generación, siempre ejecutado desde la carpeta del proyecto.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php bin/console doctrine:generate:entities AppBundle/Entity/Blog</span><br><span class="line"></span><br><span class="line">php bin/console doctrine:generate:entities AppBundle/Entity/Category</span><br></pre></td></tr></table></figure>

<h3 id="Gestion-de-la-base-de-datos"><a href="#Gestion-de-la-base-de-datos" class="headerlink" title="Gestión de la base de datos"></a>Gestión de la base de datos</h3><p>Ahora que ya tenemos el modelo mapeado y con los suficientes métodos para ser usado podemos, mediante el comando symfony, hacer que los datos persistan en nuestro motor SQL. Desde el shell/cmd introducimos…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php bin/console doctrine:schema:update --force</span><br></pre></td></tr></table></figure>

<p>Este comando es muy versátil, analiza las estructuras encontradas en la base de datos contra el mapeado que nosotros tengamos definido en la clase de la entidad correspondiente, en caso de encontrar diferencias se encargará de hacer los updates necesarios para sincronizarlas, y, en caso de no existir las creará con sus índices primarios, claves foráneas, etc…</p>
<h3 id="Utilizando-las-entidades"><a href="#Utilizando-las-entidades" class="headerlink" title="Utilizando las entidades."></a>Utilizando las entidades.</h3><p>Con las clases de entidades ya completas y una vez creadas las tablas en la base de datos ya podemos empezar a utilizar los objetos dentro de nuestro proyecto para hacer persistir los datos que gestiona.</p>
<p>Dentro de nuestro Blog controller podemos instanciar la clase de entidad, con esta a través de la herencia y de la generación de getters y setters nos podremos realizar todas las operaciones pertinentes. Tomando la base ya hecha del blog vamos a desarrollar un poco más el controller, más tarde aprovecharemos estas Action para poblarlas con las acciones del CRUD que vayamos programando para el backend.</p>
<h3 id="Creacion-de-una-entidad"><a href="#Creacion-de-una-entidad" class="headerlink" title="Creación de una entidad."></a>Creación de una entidad.</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/AppBundle/Controller/BlogController.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AppBundle</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Bundle</span>\<span class="title">FrameworkBundle</span>\<span class="title">Controller</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Sensio</span>\<span class="title">Bundle</span>\<span class="title">FrameworkExtraBundle</span>\<span class="title">Configuration</span>\<span class="title">Route</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">AppBundle</span>\<span class="title">Entity</span>\<span class="title">Blog</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Route</span>("/blog/create", name="blog_create")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">new</span> Blog();</span><br><span class="line">        $blog-&gt;setCategory(<span class="number">1</span>);</span><br><span class="line">        $blog-&gt;setTitle(<span class="string">'My first blog post'</span>);</span><br><span class="line">        $blog-&gt;setSlug(<span class="string">'my-first-blog-post'</span>);</span><br><span class="line">        $blog-&gt;setContent(<span class="string">'lorem ipsum...'</span>);</span><br><span class="line">        $blog-&gt;setCreated(date_create(date(<span class="string">'Y-m-d H:i:s'</span>)));</span><br><span class="line">        $blog-&gt;setModified(date_create(date(<span class="string">'Y-m-d H:i:s'</span>)));</span><br><span class="line"></span><br><span class="line">        $em = <span class="keyword">$this</span>-&gt;getDoctrine()-&gt;getManager();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Indicamos que queremos guardar este registro.</span></span><br><span class="line">        $em-&gt;persist($blog);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ejecuta las querys de las operaciones indicadas.</span></span><br><span class="line">        $em-&gt;flush();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'Saved new $blog entry with id '</span>.$blog-&gt;getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Previous Code.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Route</span>("/blog/&#123;page&#125;", name="blog_list", requirements=&#123;"page": "\d+"&#125;)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listAction</span><span class="params">($page=<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(</span><br><span class="line">            <span class="string">'&lt;html&gt;&lt;body&gt;Showing page number: '</span>.$page.<span class="string">'&lt;/body&gt;&lt;/html&gt;'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Route</span>("/blog/&#123;title&#125;", name="blog_read", requirements=&#123;"title": "\S+"&#125;)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readAction</span><span class="params">($title)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(</span><br><span class="line">            <span class="string">'&lt;html&gt;&lt;body&gt;Showing post:'</span>.$title.<span class="string">'&lt;/body&gt;&lt;/html&gt;'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nada más acceder a la ruta <a href="http://localhost:8000/blog/create" target="_blank" rel="noopener">http://localhost:8000/blog/create</a> se ejecutará la acción que creará un registro en la base de datos, cuando veamos el mensaje de éxito podemos acceder a nuestro gestor BD para comprobar que realmente se guardado el registro. Vamos a desglosar un poco la operación.</p>
<ul>
<li>Instanciamos la entidad Blog.</li>
<li>A través de los setter (setXxxxx) damos valores a las propiedades que se mapean con los campos de la tabla.</li>
<li>Obtenemos la instancia del Gestor de entidades de Doctrine, que será el encargado de hacer persistir los datos del objeto en la Base de datos.</li>
<li>Invocamos la función persist que se encargará de la operación de escritura, hay que tener en cuenta que Doctrine funciona en un ámbito tipo transaccional, de manera que tras realizar las operaciones pertinentes debemos indicarle que estas se fijan permanentemente en la BD, mediante el comando flush, que en este contexto funcionará como un commit en una transacción. En caso de haber algún problema con la operación se levantara una excepción de tipo Doctrine\ORM\ORMException.</li>
<li>Flush es realmente el método encargado de ejecutar las querys necesarias, Doctrine es consciente de las entidades que gestiona y a través de esta función las querys serán lanzadas en orden y en caso de ser posible aplicará estrategias de optimización para poder ejecutar todo en las menores operaciones posibles. Si por ejemplo realizamos 100 operaciones persist, flush intentará preparar una única query para realizar las 100 inserciones en BBDD.</li>
</ul>
<h3 id="Acceso-a-datos-de-entidades"><a href="#Acceso-a-datos-de-entidades" class="headerlink" title="Acceso a datos de entidades"></a>Acceso a datos de entidades</h3><p>Tras una operación de creación podemos codificar también una operación de lectura de los registros creados, al controlador le podremos añadir el siguiente método.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Route</span>("/read/&#123;slug&#125;", name="blog_read", requirements=&#123;"slug": "\S+"&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readAction</span><span class="params">($slug)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $blog = <span class="keyword">$this</span>-&gt;getDoctrine()</span><br><span class="line">        -&gt;getRepository(<span class="string">'AppBundle:Blog'</span>)</span><br><span class="line">        -&gt;findOneBySlug($slug);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!$blog) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">$this</span>-&gt;createNotFoundException(</span><br><span class="line">            <span class="string">'No blog entry found for '</span>.$slug</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'&lt;h1&gt;'</span>.$blog-&gt;getTitle().<span class="string">'&lt;/h1&gt;&lt;br&gt;'</span>.$blog-&gt;getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Podremos ver el contenido de la noticia accediendo a <a href="http://localhost:8000/read/my-first-blog-post" target="_blank" rel="noopener">http://localhost:8000/read/my-first-blog-post</a>. Al realizar querys sobre una determinada entidad podemos utilizar el repositorio, el repositorio es un objeto especializado en obtener datos de la base de datos para una determinada clase. De manera que al invocar</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$repository = <span class="keyword">$this</span>-&gt;getDoctrine()</span><br><span class="line">    -&gt;getRepository(<span class="string">'AppBundle:Blog'</span>);</span><br></pre></td></tr></table></figure>

<p>Doctrine se encargará de instanciar y devolvernos un objeto repositorio basado en la clase-entidad Blog. La notación AppBundle:Blog en realidad es un shorcut para evitar usar todo el namespace de la clase entidad en la que se va a basar. Es equivalente a <strong>AppBundle\Entity\Blog</strong>. Este shortcut funcionará siempre que nuestra entidad este alojada en el directorio estándar para las entidades, AppBundle/Entity. A la función de la creación del repositorio se le <strong>encadena</strong> la llamada al método <strong>findOneBySlug()</strong> encargado de obtener el registro Blog correspondiente al slug pasado como parámetro y devolverlo encapsulado en su propio objeto de entidad Blog.</p>
<p>En el repositorio tenemos a nuestra disposición distintos cauces para poder obtener registros de nuestra entidad.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$repository = <span class="keyword">$this</span>-&gt;getDoctrine()-&gt;getRepository(<span class="string">'AppBundle:Blog'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Obtener el registro de una única noticia por la clave primaria (generalmente ID)</span></span><br><span class="line">$blog = $repository-&gt;find($blogId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Nombres dinámicos de métodos para encontrar un único registro</span></span><br><span class="line"><span class="comment">// basándonos en el valor de una columna de la BD</span></span><br><span class="line">$blog = $repository-&gt;findOneById($blogId);</span><br><span class="line">$blog = $repository-&gt;findOneByTitle(<span class="string">'My first blog post'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Todos los métodos anteriores devuelven un objeto</span></span><br><span class="line"><span class="keyword">echo</span> $blog-&gt;getContent();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Nombres dinámicos de métodos para encontrar un conjunto de registros</span></span><br><span class="line"><span class="comment">// basándonos en el valor de una columna de la BD</span></span><br><span class="line">$blog = $repository-&gt;findByCategory(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Encuentra *todas* las entradas de blog</span></span><br><span class="line">$blog = $repository-&gt;findAll();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Devolverán una colección de resultados</span></span><br><span class="line"><span class="keyword">echo</span> $blog[<span class="number">0</span>]-&gt;getContent();</span><br></pre></td></tr></table></figure>

<p>Para crear búsquedas un poco más complejas podremos utilizar los métodos <strong>findBy</strong> y <strong>findOneBy</strong>, que son métodos donde podremos utilizar más filtros para refinar las búsquedas.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$repository = <span class="keyword">$this</span>-&gt;getDoctrine()-&gt;getRepository(<span class="string">'AppBundle:Blog'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query para encontrar una sola entrada de blog con ese título y categoría</span></span><br><span class="line">$blog = $repository-&gt;findOneBy(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">'title'</span> =&gt; <span class="string">'My first blog post'</span>, <span class="string">'category'</span> =&gt; <span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// query para obtener múltiples registros en atención a la categoría y ordenados por fecha.</span></span><br><span class="line">$blog = $repository-&gt;findBy(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">'category'</span> =&gt; <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">'created'</span> =&gt; <span class="string">'DESC'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Modificacion-de-registros"><a href="#Modificacion-de-registros" class="headerlink" title="Modificación de registros"></a>Modificación de registros</h3><p>Supongamos que tenemos una ruta que mapea un id de noticia a una acción update.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Route</span>("/blog/update/&#123;blogId&#125;", name="blog_update", requirements=&#123;"blogId": "\d+"&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateAction</span><span class="params">($blogId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $em   = <span class="keyword">$this</span>-&gt;getDoctrine()-&gt;getManager();</span><br><span class="line">    $blog = $em-&gt;getRepository(<span class="string">'AppBundle:Blog'</span>)-&gt;find($blogId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!$blog) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">$this</span>-&gt;createNotFoundException(</span><br><span class="line">            <span class="string">'No post found for id '</span>.$blogId</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $blog-&gt;setTitle(<span class="string">'Updated blog entry!'</span>);</span><br><span class="line">    $em-&gt;flush();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;redirectToRoute(<span class="string">'blog_list'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="http://localhost:8000/blog/update/1" target="_blank" rel="noopener">http://localhost:8000/blog/update/1</a>. Son tres sencillos pasos, a través del ID obtenemos el objeto de la base de datos, modificamos el atributo que nos interesa y finalmente invocamos la función <strong>flush()</strong>. En este caso no es necesario utilizar <strong>persist()</strong>, ya que al obtener el objeto del registro a través del entity manager, el propio <strong>flush()</strong> busca las modificaciones realizadas en el objeto y lo hace persistir. <strong>Persist()</strong> hace que el gestor de entidades setee un watch sobre un objeto ya existente y al hacer <strong>flush()</strong> busca sus cambios para guardarlo, en el caso anterior este watch ya viene implementado.</p>
<h3 id="Borrado-de-registros"><a href="#Borrado-de-registros" class="headerlink" title="Borrado de registros"></a>Borrado de registros</h3><p>Tras obtener el objeto solo debemos utilizar el método remove y tras esto hacer el flush para lanzar la operación.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Route</span>("/blog/delete/&#123;blogId&#125;", name="blog_delete", requirements=&#123;"blogId": "\d+"&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteAction</span><span class="params">($blogId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $em   = <span class="keyword">$this</span>-&gt;getDoctrine()-&gt;getManager();</span><br><span class="line">    $blog = $em-&gt;getRepository(<span class="string">'AppBundle:Blog'</span>)-&gt;find($blogId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!$blog) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">$this</span>-&gt;createNotFoundException(</span><br><span class="line">            <span class="string">'No post found for id '</span>.$blogId</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $em-&gt;remove($blog);</span><br><span class="line">    $em-&gt;flush();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;redirectToRoute(<span class="string">'blog_list'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="http://localhost:8000/blog/delete/1" target="_blank" rel="noopener">http://localhost:8000/blog/delete/1</a>.</p>
<h3 id="Relaciones-entre-las-entidades"><a href="#Relaciones-entre-las-entidades" class="headerlink" title="Relaciones entre las entidades"></a>Relaciones entre las entidades</h3><p>A través de las notaciones en comentarios podremos <a href="http://symfony.com/doc/current/doctrine/associations.html" target="_blank" rel="noopener">definir relaciones entre entidades</a>, de manera que si las noticias del blog se relacionan con una categoría, podamos, al buscar una entrada del blog también recuperar el objeto de entidad de su categoría asociada. En este caso una categoría puede pertenecer a múltiples noticias y cada noticia solo se puede asociar a una categoría, el tipo de relación dependerá de dónde hagamos la notación, ya que la relación blog - categoría, descrita en la entidad Blog, es many (entradas de blog) to one (Categoría) pero la relación descrita en la entidad categoría (Categoría - blog) sera one (Categoría) to many (entradas de blog). En el segundo caso será necesario a su vez relacionar la propiedad de la relación que corresponde con el objeto Blog a un objeto tipo Collection para que al traer el registro de una categoría, esta pueda traer a su vez una colección con todas las noticias de Blog relacionadas. En caso de trabajar bajo este contexto deberemos tener cuidado con el alcance, ya que al pedir una simple categoría podremos recibir todas las noticias asociadas a esta con su consecuente carga en tiempo y memoria, de manera que en cada caso acotaremos la profundidad de la query según nos interese.</p>
<p>Los mapeos de las relaciones en el objeto se realizan sobre las propiedades que representan al campo índice de la relación.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/AppBundle/Entity/Blog.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\ManyToOne(targetEntity="Category", inversedBy="blogs")</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\JoinColumn(name="category_id", referencedColumnName="id")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $category;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/AppBundle/Entity/Category.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Doctrine</span>\<span class="title">Common</span>\<span class="title">Collections</span>\<span class="title">ArrayCollection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ORM</span>\OneToMany(targetEntity="Blog", mappedBy="category")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $blogs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blogs = <span class="keyword">new</span> ArrayCollection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>En caso de definir la relación lo mejor sera recrear los getter/setter de las clases y hacer un force-update de la base de datos para que quede bien reflejado.</p>
<h3 id="Construyendo-querys-con-Doctrine"><a href="#Construyendo-querys-con-Doctrine" class="headerlink" title="Construyendo querys con Doctrine"></a>Construyendo querys con Doctrine</h3><p>Para esta tarea Doctrine implementa un lenguaje denominado <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/dql-doctrine-query-language.html" target="_blank" rel="noopener">DQL</a> que es muy similar al SQL estándar. Podríamos utilizar este lenguaje para construir querys muy complejas pero creo que es mejor no centrarnos en el lenguaje, si no en como construir estas querys a través de los <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/query-builder.html" target="_blank" rel="noopener">métodos del QueryBuilder</a>. Este objeto mediante nuestra parametrización se encargará de generar las sentencias DQL que precisemos. Si el lenguaje sufre variaciones, los propios objetos que lo construyen serán actualizados y seguirán generando querys válidas, mientras que si lo hacemos a través de consultas DQL escritas a mano tendremos que corregir aquellas que no se adapten a la nueva norma.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$repository = <span class="keyword">$this</span>-&gt;getDoctrine()</span><br><span class="line">    -&gt;getRepository(<span class="string">'AppBundle:Blog'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// createQueryBuilder() automatically selects FROM AppBundle:Blog</span></span><br><span class="line"><span class="comment">// and aliases it to "p"</span></span><br><span class="line">$query = $repository-&gt;createQueryBuilder(<span class="string">'p'</span>)</span><br><span class="line">     -&gt;where(<span class="string">'p.id &gt; :id'</span>)</span><br><span class="line">     -&gt;orderBy(<span class="string">'p.created'</span>, <span class="string">'ASC'</span>)</span><br><span class="line">     -&gt;getQuery();</span><br><span class="line"> $query-&gt;setParameter(<span class="string">'id'</span>, <span class="number">1</span>);</span><br><span class="line">$blogs = $query-&gt;getResult();</span><br><span class="line"><span class="comment">// to get just one result:</span></span><br><span class="line"><span class="comment">// $blog = $query-&gt;setMaxResults(1)-&gt;getOneOrNullResult();</span></span><br></pre></td></tr></table></figure>

<h3 id="FIN"><a href="#FIN" class="headerlink" title="FIN"></a>FIN</h3><p>Con esto he pasado un poco por encima de todo aquello que creo tiene algo de relevancia a la hora de trabajar con el ORM Doctrine de Symfony, toda la información se puede ampliar mediante la documentación oficial de Symfony. En la próxima sesión tratare de definir un poco más la estructura de datos que vamos a utilizar para el backend y hacer una pequeña presentación de los Bundles.</p>
</div><div class="tags"><a href="/tags/PHP/">PHP</a><a href="/tags/Herramientas/">Herramientas</a><a href="/tags/Tutorial/">Tutorial</a><a href="/tags/Frameworks/">Frameworks</a></div><div class="post-nav"><a href="/descarga-ficheros-comprimidos-Archivestream-php/" class="pre"><i class="icon-previous">Descarga de ficheros comprimidos con ArchiveStream-php</i></a><a href="/tutorial-symfony-twig/" class="next">Tutorial de Symfony 3: Twig, base layout con Bootstrap<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'mercenariophp';
var disqus_identifier = 'tutorial-symfony-doctrine-orm/';
var disqus_title = 'Tutorial de Symfony 3: Doctrine ORM y Base de Datos';
var disqus_url = 'https://www.mercenariophp.com/tutorial-symfony-doctrine-orm/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mercenariophp.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"><input type="hidden" name="sitesearch" value="https://www.mercenariophp.com"></form></div><div class="widget lessMargin"><div style="text-align: left;"><div style="width: 84px; height: 40px;"><a href="https://twitter.com/mercenariophp" rel="nofollow" target="_blank" class="twitter_big"></a><a href="https://es.linkedin.com/in/moisés-barquín-salgado-b6148296" rel="nofollow" target="_blank" class="linkedin_big"></a></div></div></div><div class="widget"><div class="widget-title">Categorías</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Desarrollo/">Desarrollo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tutoriales-Symfony/">Tutoriales Symfony</a></li></ul></div><div class="widget"><div class="widget-title">Etiquetas</div><div class="tagcloud"><a href="/tags/tests/" style="font-size: 15px;">tests</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/PagesGenerator/" style="font-size: 15px;">PagesGenerator</a> <a href="/tags/Herramientas/" style="font-size: 15px;">Herramientas</a> <a href="/tags/Tutorial/" style="font-size: 15px;">Tutorial</a> <a href="/tags/PHPUnit/" style="font-size: 15px;">PHPUnit</a> <a href="/tags/Composer/" style="font-size: 15px;">Composer</a> <a href="/tags/NetBeans/" style="font-size: 15px;">NetBeans</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/ReactPHP/" style="font-size: 15px;">ReactPHP</a> <a href="/tags/Slim/" style="font-size: 15px;">Slim</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/Pattern/" style="font-size: 15px;">Pattern</a> <a href="/tags/Repositorio/" style="font-size: 15px;">Repositorio</a> <a href="/tags/Frameworks/" style="font-size: 15px;">Frameworks</a></div></div><div class="widget"><div class="widget-title">Recientes</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/php-dotenv-variables-entorno/">PHP Dotenv, configuración en variables de entorno</a></li><li class="post-list-item"><a class="post-list-link" href="/vacaciones/">Vacaciones</a></li><li class="post-list-item"><a class="post-list-link" href="/retornando-objetos-valor/">Retornando objetos de valor en lugar de arrays</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-bundles-knpmenubundle/">Tutorial de Symfony 3: Bundles y KnpMenuBundle</a></li><li class="post-list-item"><a class="post-list-link" href="/descarga-ficheros-comprimidos-Archivestream-php/">Descarga de ficheros comprimidos con ArchiveStream-php</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-doctrine-orm/">Tutorial de Symfony 3: Doctrine ORM y Base de Datos</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony-twig/">Tutorial de Symfony 3: Twig, base layout con Bootstrap</a></li><li class="post-list-item"><a class="post-list-link" href="/tutorial-symfony/">Tutorial de Symfony 3: Instalación, routing y controllers</a></li><li class="post-list-item"><a class="post-list-link" href="/refactorizando-reactphp-slim/">Refactorizando reactphp-slim</a></li><li class="post-list-item"><a class="post-list-link" href="/editor-hackeable-atom/">Editor hackeable Atom, el editor para el siglo 21</a></li></ul></div><div class="widget"><div class="widget-title">Comentarios recientes</div><script type="text/javascript" src="//mercenariophp.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">Blogroll</div><ul></ul><a href="http://www.phptherightway.com/" title="PHP The Right Way" target="_blank">PHP The Right Way</a></div></div></div></div><div id="footer"><a href="https://twitter.com/mercenariophp" rel="nofollow" class="twitter"></a> <a href="https://es.linkedin.com/in/moisés-barquín-salgado-b6148296" rel="nofollow" class="linkedin"></a> © <a href="/." rel="nofollow">mercenariophp.</a> With<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-78289384-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>